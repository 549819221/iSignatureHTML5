var $jscomp={scope:{},findInternal:function(k,n,p){k instanceof String&&(k=String(k));for(var q=k.length,m=0;m<q;m++){var l=k[m];if(n.call(p,l,m,k))return{i:m,v:l}}return{i:-1,v:void 0}}};$jscomp.defineProperty="function"==typeof Object.defineProperties?Object.defineProperty:function(k,n,p){if(p.get||p.set)throw new TypeError("ES3 does not support getters and setters.");k!=Array.prototype&&k!=Object.prototype&&(k[n]=p.value)};
$jscomp.getGlobal=function(k){return"undefined"!=typeof window&&window===k?k:"undefined"!=typeof global?global:k};$jscomp.global=$jscomp.getGlobal(this);$jscomp.polyfill=function(k,n,p,q){if(n){p=$jscomp.global;k=k.split(".");for(q=0;q<k.length-1;q++){var m=k[q];m in p||(p[m]={});p=p[m]}k=k[k.length-1];q=p[k];n=n(q);n!=q&&null!=n&&$jscomp.defineProperty(p,k,{configurable:!0,writable:!0,value:n})}};
$jscomp.polyfill("Array.prototype.find",function(k){return k?k:function(k,p){return $jscomp.findInternal(this,k,p).v}},"es6-impl","es3");
var CryptoJS=CryptoJS||function(k,n){var p={},q=p.lib={},m=q.Base=function(){function r(){}return{extend:function(l){r.prototype=this;var g=new r;l&&g.mixIn(l);g.hasOwnProperty("init")||(g.init=function(){g.$super.init.apply(this,arguments)});g.init.prototype=g;g.$super=this;return g},create:function(){var g=this.extend();g.init.apply(g,arguments);return g},init:function(){},mixIn:function(g){for(var l in g)g.hasOwnProperty(l)&&(this[l]=g[l]);g.hasOwnProperty("toString")&&(this.toString=g.toString)},
clone:function(){return this.init.prototype.extend(this)}}}(),l=q.WordArray=m.extend({init:function(g,l){g=this.words=g||[];this.sigBytes=l!=n?l:4*g.length},toString:function(g){return(g||A).stringify(this)},concat:function(g){var l=this.words,r=g.words,m=this.sigBytes;g=g.sigBytes;this.clamp();if(m%4)for(var k=0;k<g;k++)l[m+k>>>2]|=(r[k>>>2]>>>24-k%4*8&255)<<24-(m+k)%4*8;else if(65535<r.length)for(k=0;k<g;k+=4)l[m+k>>>2]=r[k>>>2];else l.push.apply(l,r);this.sigBytes+=g;return this},clamp:function(){var g=
this.words,l=this.sigBytes;g[l>>>2]&=4294967295<<32-l%4*8;g.length=k.ceil(l/4)},clone:function(){var g=m.clone.call(this);g.words=this.words.slice(0);return g},random:function(g){for(var m=[],r=0;r<g;r+=4)m.push(4294967296*k.random()|0);return new l.init(m,g)}}),x=p.enc={},A=x.Hex={stringify:function(g){var l=g.words;g=g.sigBytes;for(var k=[],m=0;m<g;m++){var r=l[m>>>2]>>>24-m%4*8&255;k.push((r>>>4).toString(16));k.push((r&15).toString(16))}return k.join("")},parse:function(g){for(var k=g.length,
m=[],r=0;r<k;r+=2)m[r>>>3]|=parseInt(g.substr(r,2),16)<<24-r%8*4;return new l.init(m,k/2)}},H=x.Latin1={stringify:function(g){var l=g.words;g=g.sigBytes;for(var k=[],m=0;m<g;m++)k.push(String.fromCharCode(l[m>>>2]>>>24-m%4*8&255));return k.join("")},parse:function(g){for(var m=g.length,k=[],r=0;r<m;r++)k[r>>>2]|=(g.charCodeAt(r)&255)<<24-r%4*8;return new l.init(k,m)}},g=x.Utf8={stringify:function(g){try{return decodeURIComponent(escape(H.stringify(g)))}catch(y){throw Error("Malformed UTF-8 data");
}},parse:function(g){return H.parse(unescape(encodeURIComponent(g)))}},F=q.BufferedBlockAlgorithm=m.extend({reset:function(){this._data=new l.init;this._nDataBytes=0},_append:function(l){"string"==typeof l&&(l=g.parse(l));this._data.concat(l);this._nDataBytes+=l.sigBytes},_process:function(g){var m=this._data,r=m.words,n=m.sigBytes,q=this.blockSize,p=n/(4*q),p=g?k.ceil(p):k.max((p|0)-this._minBufferSize,0);g=p*q;n=k.min(4*g,n);if(g){for(var A=0;A<g;A+=q)this._doProcessBlock(r,A);A=r.splice(0,g);m.sigBytes-=
n}return new l.init(A,n)},clone:function(){var g=m.clone.call(this);g._data=this._data.clone();return g},_minBufferSize:0});q.Hasher=F.extend({cfg:m.extend(),init:function(g){this.cfg=this.cfg.extend(g);this.reset()},reset:function(){F.reset.call(this);this._doReset()},update:function(g){this._append(g);this._process();return this},finalize:function(g){g&&this._append(g);return this._doFinalize()},blockSize:16,_createHelper:function(g){return function(l,m){return(new g.init(m)).finalize(l)}},_createHmacHelper:function(g){return function(l,
m){return(new B.HMAC.init(g,m)).finalize(l)}}});var B=p.algo={};return p}(Math);
(function(){var k=CryptoJS,n=k.lib,p=n.WordArray,q=n.Hasher,m=[],n=k.algo.SHA1=q.extend({_doReset:function(){this._hash=new p.init([1732584193,4023233417,2562383102,271733878,3285377520])},_doProcessBlock:function(l,k){for(var n=this._hash.words,p=n[0],g=n[1],q=n[2],x=n[3],r=n[4],y=0;80>y;y++){if(16>y)m[y]=l[k+y]|0;else{var z=m[y-3]^m[y-8]^m[y-14]^m[y-16];m[y]=z<<1|z>>>31}z=(p<<5|p>>>27)+r+m[y];z=20>y?z+((g&q|~g&x)+1518500249):40>y?z+((g^q^x)+1859775393):60>y?z+((g&q|g&x|q&x)-1894007588):z+((g^q^
x)-899497514);r=x;x=q;q=g<<30|g>>>2;g=p;p=z}n[0]=n[0]+p|0;n[1]=n[1]+g|0;n[2]=n[2]+q|0;n[3]=n[3]+x|0;n[4]=n[4]+r|0},_doFinalize:function(){var l=this._data,m=l.words,k=8*this._nDataBytes,n=8*l.sigBytes;m[n>>>5]|=128<<24-n%32;m[(n+64>>>9<<4)+14]=Math.floor(k/4294967296);m[(n+64>>>9<<4)+15]=k;l.sigBytes=4*m.length;this._process();return this._hash},clone:function(){var l=q.clone.call(this);l._hash=this._hash.clone();return l}});k.SHA1=q._createHelper(n);k.HmacSHA1=q._createHmacHelper(n)})(this);
(function(k,n){"function"!==typeof define||!define.amd||"undefined"!=typeof nonUseAmd&&nonUseAmd?n():"undefined"!=typeof HTMLDev&&HTMLDev?define(["./core/kinggrid.plus"],n):define(["./core/kinggrid.plus.min"],n)})(window,function(k){function n(a){a=JSON.stringify(a);return A?a.replace(/\\u([0-9a-fA-F]{2,4})/g,function(a,c){return String.fromCharCode(parseInt(c,16))}):a}function p(a,b){var c=[],f={},h;for(h in a){var t={},u=a[h];g.is("String",u)&&(A||0!=u.indexOf("ey"))?(t["b64_"+h]=a[h],c.push(t)):
f[h]=u}var w=[];(function(a){for(var b in a)w.push((new e(b,a[b])).load(e.options))})(f);if(f=c.length)for(h=e.options.signSize||5,t=Math.ceil(f/h),u=1;u<=t;u++){var l=h*(u-1),k=h*u>f?f:h*u;I=m.surry(e.options.serverUrl);I.request(e.options.b64Url,c.slice(l,k)).ret(function(a){if(a.result)for(var b in a){if(0==b.indexOf("b64_")){var c=a[b];g.is("String",c)&&(c=JSON.parse(c));w.push((new e(b.substring(4),c)).load(e.options))}}else e.prototype.warning.call(null,a)})}I.fin(function(a,c,f){b&&b(1==w.length?
w[0]:w)})}var q=window,m=window.kinggrid,l=window.jQuery,x=window.kingPlus,A=!1;q.JSON&&(A='{"x":"\u4e2d"}'!==q.JSON.stringify({x:"\u4e2d"}));var H=!0;try{q.document.createElement("canvas").getContext("2d")}catch(a){H=!1}var g=m.Utils,F=l(window),B=l(document);k=document.documentElement;var r=!!("minWidth"in k.style)&&"onlosecapture"in k,y="setCapture"in k,z,E,N=function(a){z&&(a=a.originalEvent?a.originalEvent.touches.item(0):a.touches.item(0));return a},M=function(a){this.start=l.proxy(this.start,
this);this.over=l.proxy(this.over,this);this.end=l.proxy(this.end,this);this.onstart=this.onover=this.onend=l.noop;E||(z="mousedown"!=a.type,E={start:z?"touchstart":"mousedown",over:z?"touchmove":"mousemove",end:z?"touchend":"mouseup"})};M.prototype={start:function(a){a=this.startFix(a);C.trigger("dragStart",this,a);B.on(E.over,this.over).on(E.end,this.end);this.onstart(a);return!1},over:function(a){a=this.overFix(a);C.trigger("dragOver",this,a);this.onover(a);return!1},end:function(a){a=this.endFix(a);
C.trigger("dragEnd",this,a);B.off(E.over,this.over).off(E.end,this.end);this.onend(a);return!1},startFix:function(a){a=N(a);this.target=l(a.target);this.selectstart=function(){return!1};B.on("selectstart",this.selectstart).on("dblclick",this.end);if(r)this.target.on("losecapture",this.end);else F.on("blur",this.end);y&&this.target[0].setCapture();return a},overFix:function(a){return a=N(a)},endFix:function(a){a=N(a);B.off("selectstart",this.selectstart).off("dblclick",this.end);r?this.target.off("losecapture",
this.end):F.off("blur",this.end);y&&this.target[0].releaseCapture();return a}};M.create=function(a,b,c){var f=l(a),h=new M(b),e=E.start,g=function(){},w=a.className.replace(/^\s|\s.*/g,"")+"-drag-start",m=f[0].style,k,D,n,Q,O=0,q=0,r=parseInt(m.left),p=parseInt(m.top),v=r,x=p,y=r,z=p;c&&(v=parseInt(m.marginLeft),x=parseInt(m.marginTop),y=v,z=x);var A={onstart:g,onover:g,onend:g,off:function(){f.off(e,h.start)}};h.onstart=function(b){var c="fixed"===f.css("position"),h=B.scrollLeft(),e=B.scrollTop(),
t=f.width(),g=f.height();D=k=0;n=c?F.width()-t+k:B.width()-t;Q=c?F.height()-g+D:B.height()-g;g=f.offset();t=this.startLeft=c?g.left-h:g.left;c=this.startTop=c?g.top-e:g.top;this.clientX=b.clientX;this.clientY=b.clientY;g=f.parent();g.is("body")||(O=g[0].getBoundingClientRect().left+h,q=g[0].getBoundingClientRect().top+e);f.addClass(w);A.onstart.call(a,b,t,c)};h.onover=function(b){var h=b.clientX-this.clientX+this.startLeft,e=b.clientY-this.clientY+this.startTop,t=f[0].style,h=Math.max(k,Math.min(n,
h)),e=Math.max(D,Math.min(Q,e));c?(h=t.marginLeft=h-O-r+"px",e=t.marginTop=e-q-p+"px"):(h=t.left=h-O+"px",e=t.top=e-q+"px");y=parseInt(h);z=parseInt(e);A.onover.call(a,b,h,e)};h.onend=function(b){var h=f.position(),e=h.left,h=h.top;f.removeClass(w);var t=f[0].style,g=!0;6>Math.abs(y-v)&&6>Math.abs(z-x)&&(g=!1);c?A.onend.call(a,b,g,t.marginLeft,t.marginTop):A.onend.call(a,b,g,e,h)};h.off=function(){f.off(e,h.start)};if(b)h.start(b);else f.on(e,h.start);return A};k=m.Listener;var G=function(){};l.extend(G.prototype,
k.prototype);var J=function(){};J.className=J.name||"SealService";g.inherit(J,G);l.extend(J.prototype,{loadSeal:function(){throw Error("must impl");},saveLog:function(){},verifyPwd:function(){throw Error("must impl");}});var K=function(){};K.className=K.name||"CertService";g.inherit(K,G);l.extend(K.prototype,{sign:function(){throw Error("must impl");},verifySign:function(){throw Error("must impl");}});G=function(){};l.extend(G.prototype,{getAttr:function(a){return this[a]},setAttr:function(a){var b=
this;l.each(a,function(a,f){if("function"===typeof b[a])b[a](f);else b[a]=f})},removeAttr:function(a){delete this[a]}});var e=function(a,b){var c=this;c.signatureid=a;c.setSignatureData(b);c.on("load",function(){e.list[a]=this});c.on("remove",function(a){a=c._getLogInfo(g.extend(a||{},{LOGTYPE:"00",LOGSORT:"14",LOGMEMO:"\u64a4\u9500\u7b7e\u7ae0\u6210\u529f"}));c.sealService.saveLog(a);delete e.list[c.signatureid]});c.on("update",function(a){"signMeta"===c._item&&(a=c._getLogInfo(g.extend(a||{},{LOGTYPE:"00",
LOGSORT:"304",LOGMEMO:"\u6570\u5b57\u7b7e\u540d\u6210\u529f"})),c.sealService.saveLog(a))});c.on("fireremove",function(){e.removeList.push(c.signatureid)});c.on("fireupdate",function(){for(var a=!1,b=0;b<e.updateList.length;b++)if(e.updateList[b]===c){a=!0;break}a||e.updateList.push(c)});for(var f in e)e.hasOwnProperty(f)&&0==f.indexOf("on")&&(this[f]=e[f]);return this},R=function(a,b,c){var f;if(H){f=q.document.createElement("canvas");f.height=c;f.width=b;var h=f.getContext("2d"),e=new Image;e.src=
a;e.onload=function(){h.drawImage(e,0,0,b,c)}}else f=q.document.createElement("img"),f.style.width=b+"px",f.style.height=c+"px",f.setAttribute("src",a);return f};g.inherit(e,G);l.extend(e.prototype,k.prototype);l.extend(e.prototype,{hashAlg:"sha1",encryptAlg:"RSA",_init:function(){},_getLogInfo:function(a){var b=decodeURIComponent(window.location.href),c=this.signatureData;return g.extend(a||{},{KEYSN:c.keysn,SIGNSN:c.seal.signsn,DOCUMENTID:c.documentid,DOCUMENTNAME:c.documentname,APPVERSION:S.name,
APPTYPE:"HTML",APPCODE:this.appcode,EXTPARAM2:b})},warning:function(a){var b=a;g.is("Object",a)&&(b=a.errcode&&"511"!=a.errcode?a.errcode:a.errmsg);b||(b="\u91d1\u683c\u7ec4\u4ef6\u672a\u77e5\u9519\u8bef");var c=g.is("String",arguments[1])?c:"then",f=arguments[arguments.length-1];v.alert(m.msg(b,c),function(){v.hideLoading();return g.is("Function",f)?f():!0})},error:function(a,b,c){var f=a;g.is("Object",a)&&(f=a.errcode&&"511"!=a.errcode?a.errcode:a.errmsg);f||(f="\u91d1\u683c\u7ec4\u4ef6\u672a\u77e5\u9519\u8bef");
b=g.is("String",b)?b:"then";v.alert(m.msg(f,b),function(){v.hideLoading();return g.is("Function",c)?c():!0})},load:function(a){this.trigger("beforeLoad");this.setAttr(a);this.certService=new e.factory.cert[e.options.certType](a,this.signatureData);var b=this.signatureData;void 0!==a.extra&&null!==a.extra&&void 0!==a.extra[this.signatureid]?(void 0!==a.extra[this.signatureid].scaleImage&&null!==a.extra[this.signatureid].scaleImage&&(b.seal.height*=a.extra[this.signatureid].scaleImage,b.seal.width*=
a.extra[this.signatureid].scaleImage),void 0!=a.extra[this.signatureid].position&&(this.removeItem(b.position),this.updatePos(a.extra[this.signatureid].position,{marginLeft:a.extra[this.signatureid].offsetX,marginTop:a.extra[this.signatureid].offsetY}))):void 0!==a.scaleImage&&null!==a.scaleImage&&(b.seal.height*=a.scaleImage,b.seal.width*=a.scaleImage);this.sealService=new e.factory.seal[e.options.sealType](a,b);this._init();this.trigger("load");return this},toBase64Img:function(a){var b=a.imgdata,
c=b.indexOf(a.signsn);if(-1==c)return b;b=a.imgdata.substring(c+65);return g.Base64.of().encodeByte(g.Base64.of(a.signsn).decodeByte(b))},clearImg:function(){if(this.imgEles)for(var a in this.imgEles)this.trigger("removeAt",this.imgEles[a][0]),this.imgEles[a].remove();this.imgEles={}},repaint:function(){this.clearImg();this.verify()},getUpdateType:function(){return this._item},updatePos:function(a,b){var c=this.signatureData.position[a];this._item="position";this.signatureData.position[a]=g.extend({},
c,b)},updateItem:function(a,b){this._item=a;this.signatureData[a]=b},removeItem:function(a){for(var b in a)delete a[b]},fireUpdate:function(a){var b=this,c=function(c){a&&a(c);b[c?"update":"restore"]();delete b._item};e.asyn.update?e.asyn.update.call(b,c):(this.trigger("fireupdate"),c(!0));return this},restore:function(){this.setSignatureData(this.oriSignatureData);this.repaint()},update:function(){this.setSignatureData(this.signatureData);this.repaint();this.trigger("update");return this},remove:function(){this.clearImg();
this.trigger("remove");for(var a in this)delete this[a];return this},fireRemove:function(a){var b=this,c=function(c){a&&a(c);c&&b.remove()};e.asyn.remove?e.asyn.remove.call(b,c):(this.trigger("fireremove"),c(!0));return this},hide:function(){if(this.imgEles)for(var a in this.imgEles)this.imgEles[a].hide()},createImg:function(){var a=this.signatureData,b=l(document.createElement("img")),c="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVR42mNgAAIAAAUAAen63NgAAAAASUVORK5CYII=";
this.broken||(c="data:image/"+a.seal.imgext+";base64,"+this.toBase64Img(a.seal));b.css({width:Math.ceil(9600*parseFloat(a.seal.width)/254),height:Math.ceil(9600*parseFloat(a.seal.height)/254)}).attr({src:c});return b},show:function(){var a=this.signatureData.position,b=this.imgEles=this.imgEles||{},c;for(c in a){var f="kg-img-div-"+this.signatureid+"-"+c,h=b[f];h||(h=b[f]=this.showAt(c,a[c]));this._handleImg(h)}this.trigger("show")},showAt:function(a,b){this.trigger("beforeShowAt",a,b);var c=g.$(a),
f=l(c);this.extra&&this.extra[this.signatureid]&&(c=this.extra[this.signatureid].scopePosition)&&(f=c instanceof Object?c.find("#"+a):l(g.$(c)).find("#"+a));if(0==f.length)if(e.options.defaultPos)a=e.options.defaultPos,f=l(g.$(a));else throw Error("no find position:"+a+" signatureid="+this.signatureid);var h=this.createImg();h.addClass("kg-img").attr("id","kg-img-"+this.signatureid);c=l(document.createElement("div")).addClass("kg-img-div").addClass("kg-img-div-"+a).attr({id:"kg-img-div-"+this.signatureid+
"-"+a,elemid:a,signatureid:this.signatureid});c.append(h);c.css({width:h.width(),height:h.height()});h=this.signatureData.dateTime;null!=h&&h.isCheck&&h.fontDate&&this.addDateToImg(h.fontDate,this.signatureData.timestamp.time,c);var h=c,t="kg-default",u,w=f.attr("display");if(w)f.addClass("display-"+w),t="kg-"+w,u=f,h=document.getElementById("kg-img-container-"+a),h||(h=document.createElement("div"),h.setAttribute("id","kg-img-container-"+a)),h=l(h).addClass(t+"-container"),h.append(c),c.attr("kg-display",
!0);else if(u=f.offsetParent(),"html"==u[0].tagName.toLowerCase()||"relative"==u[0].style.position)u=l("body");c.addClass(t);u.append(h);if(w){if("landscape"===w){var f=h.children(),t=h.parent().width(),m=0;f.each(function(){m+=parseInt(l(this).width())+1});h.width(m>t?m:t)}}else this.calSealPos(f,c,h,b);this.trigger("showAt",c[0],a,b);return c},calSealPos:function(a,b,c,f){var h=a.offsetParent();c=c||b;if("html"==h[0].tagName.toLowerCase()||"relative"==h[0].style.position)h=l("body");a=a.offset();
var e=h.offset();h.is("body")&&(e={top:0,left:0});c.css({top:a.top-e.top,left:a.left-e.left});f?(h=f.marginLeft,f=f.marginTop):(h=b.css("marginLeft"),f=b.css("marginTop"));b.css({marginLeft:h||0,marginTop:f||0})},addDateToImg:function(a,b,c){b=m.Utils.formatDate(new Date(b),a.fontFormat);var f=l(document.createElement("div")).addClass("kg-date"),h=0,e=0;"outside"==a.fontPosition[2]&&("right"==a.fontPosition[3]?h+=c.width():"left"==a.fontPosition[3]&&(h-=c.width()),"below"==a.fontPosition[4]&&(e+=
c.height()));f.css({width:c.width(),height:c.height(),top:e,left:h});h=l(document.createElement("div")).addClass("kg-date-tmb").css({width:c.width()});e=l(document.createElement("div")).addClass("kg-date-lcr").css({"text-align":a.fontPosition[0],"font-family":a.fontFamily,"font-size":a.fontSize+"px",color:a.fontColor});"bottom"==a.fontPosition[1]?h.css({bottom:0}):"middle"==a.fontPosition[1]&&e.css({"line-height":c.height()+"px"});e.html(b);h.html(e);f.html(h);c.append(f)},canSign:function(){return!this.modified&&
!e.options.readonly&&e.options.signable&&!this.signatureData.signMeta},canMove:function(a){return!e.options.readonly&&this.signatureData.moveable&&e.options.moveable&&!l(a).attr("kg-display")},canDelete:function(){return!e.options.readonly},_handleImg:function(a){a.show();if(0==a.children(".kg-shade").length){var b=l(document.createElement("div")).addClass("kg-shade");b.append(R("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAAC0lEQVR42mNgAAIAAAUAAen63NgAAAAASUVORK5CYII=",a.width(),
a.height()));a.append(b)}this._invalid(a);this.trigger("handleImg",a[0])},setSignatureData:function(a){g.is("String",a)?this.signatureData=JSON.parse(g.Base64.of().decode(a)):this.signatureData=a;this.oriSignatureData=JSON.parse(JSON.stringify(this.signatureData))},getSignatureid:function(){return this.signatureid},getSignatureData:function(){var a=JSON.stringify(this.signatureData);return g.Base64.of().encode(a)},getBase64Image:function(a,b,c,f){c="kg-img-div-"+a+"-"+c;c=document.getElementById(c);
null!=c&&html2canvas(c).then(function(c){c=c.toDataURL("image/png").split(",");2<=c.length&&f&&f(c[1],a,b)})},_invalid:function(a){var b=a.children(".kg-invalid");if(0==b.length){b=l(document.createElement("div")).addClass("kg-hide").addClass("kg-invalid");a.append(b);var c=a.height()/3;b.css({top:c,height:c});for(var c=c/3,f=a.width(),h=0;3>h;h++){var e=l(document.createElement("div")).height(c);0==h%2&&(e.addClass("kg-invalid-item"),e.append(R("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAIAAACQd1PeAAAADElEQVR42mNoaGgAAAMEAYF1LgG8AAAAAElFTkSuQmCC",
f,c)));b.append(e)}}if(this.modified){c="";for(f=0;f<this.modifiedItems.length;f++)h=this.modifiedItems[f],c+=h.desc+"["+h.field+"]\u7531{"+h.orivalue+"}\u66f4\u6539\u4e3a{"+h.newvalue+"};";a.attr("modified",c).addClass("error");b.removeClass("kg-hide")}else a.removeAttr("modified").removeClass("error"),b.addClass("kg-hide")},_verify:function(a,b){this.trigger("before_verify");var c=this.verifyProtectedData(a);if(!b||b&&b.batchVerify||null==this.oriSignatureData.timestamp.timestampInfo)return this.show(),
this.trigger("_verify"),!c;var f=this;this.getVerifyTimeStamp(this.oriSignatureData.timestamp.timestampInfo,function(a){f.timeVerify=a;f.show();f.trigger("_verify");b&&b.sucCall&&b.sucCall.call(f)})},verify:function(a,b){this.trigger("beforeVerify");var c=this._verify(a,b);this.trigger("verify");return c},getVerifyProtectedData:function(){for(var a=this.validatedData,b=this.signatureData.protectedData,c={},f=0;f<b.length;f++){var h=b[f],e=h.field,u=a&&a[e];if(!u){var w=g.$(e);if(w){if(u=w.getAttribute("kg-value")||
w.value,void 0===u||null===u)u=w.innerHTML||w.innerText}else u=void 0!=h.name&&null!=h.name?document.getElementById(h.name).value:""}h=g.val(u,this);h=this._formatValue(h);c[e]=h}return c},getSignTimeStamp:function(a){for(var b={},c=0;c<a.length;c++)b[a[c].field]=a[c].value;return g.Base64.of().encode(n(b))},getValidatedTimeStamp:function(){var a=this.getVerifyProtectedData(),a=n(a);return g.Base64.of().encode(a)},getVerifyTimeStamp:function(a,b){var c=this.getValidatedTimeStamp(),f=a.CertData,h=
m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");h.invoke("SetParamByName","TSCERTDATA",g.Base64.of().encode(f)).ret(function(){h.invoke("KGVerifyTSWithReq",a.TimeStampResponse,a.TimeStampResult,"",c,a.TimeStr,"").ret(function(a){b.call(this,a.result)})})},getH5SignData:function(){var a=this.hashAlg,b=this.encryptAlg,c=CryptoJS.SHA1(this.getSignData()).toString();return[{hashAlg:a,encryptAlg:b,signdata:c}]},verifyProtectedData:function(a){a&&(this.validatedData=
a);a=[];for(var b=this.getVerifyProtectedData(),c=this.signatureData.protectedData,f=0;f<c.length;f++){var h=c[f],e=b[c[f].field];e!==h.value&&a.push({field:h.field,desc:h.desc,orivalue:h.value,newvalue:e})}this.modified=0<a.length;this.modifiedItems=a;return this.modified},verifySignData:function(a){var b=this;v.showLoading();var c=this.certService,f;if(this.signatureData.signMeta.html2sign){c instanceof L||(c=new L(e.options),c.sData=b.signatureData);f=b.getVerifyProtectedData();for(var h=this.signatureData.protectedData,
g=[],u=0;u<h.length;u++){var w=h[u],m={},k;for(k in w)w.hasOwnProperty(k)&&(m[k]=w[k]);m.value=f[w.field];g.push(m)}f=n(g)}else f=this.getValidatedSignData();c.verifySign(l.extend({signeddata:this.signatureData.signMeta.signeddata,crtdata:this.signatureData.signMeta.certinfo.crtdata,keysn:this.signatureData.keysn,signsn:this.signatureData.seal.signsn,signdata:f},{successCall:function(c){v.hideLoading();var f;c.errcode||(b.signModified=!c.result,f=b.verify(null,{sucCall:function(){a&&a(c)}}));null!=
f&&a&&a(c)},errorCall:function(a){b.error(a)}}))},_renderValue:function(a){return a.replace(/\r\n/ig,"<br>")},_formatValue:function(a,b){var c=a;c&&(c=c.replace(/\r\n/ig,"\n"),c=c.replace(/\n/ig,"\r\n"));return c},getItemVal:function(a){var b;if(b=g.is("String",a)?g.$(a):a)return a=b.tagName.toLowerCase(),"input"===a||"textarea"===a||"select"===a||"div"===a?b.getAttribute("kg-value")||b.value:b.getAttribute("kg-value")||(A?b.innerText:b.textContent);throw Error("No find protectedItem:"+a+" signatureid="+
this.signatureid);},getProtectedData:function(a){var b=this,c=[],f=function(a){var c=g.$(a);if(c){var f={field:a};f.desc=c.getAttribute("kg-desc")||a;f.value=b.getItemVal(c);return f}throw Error("No find protectedItem:"+a+" signatureid="+this.signatureid);},h=function(a){if(g.is("String",a))a=f(a);else if(!g.is("Object",a)||!a.field)throw Error("Unsupported protectedItems:"+a.toString);g.is("Function",a.value)&&(a.value=a.value.call(b,a.field,a.desc));a.value=b._formatValue(a.value);return a};if(a)if(g.is("Array",
a))for(var e=0,u=a.length;e<u;e++)c.push(h(a[e]));else c.push(h(a));return c},__findSignedData:function(a){if(g.is("String",a))return a.split(";")[0];if(g.is("Array",a))return a[0];throw Error("error signeddata: "+a);},getValidatedSignData:function(){var a=this.getVerifyProtectedData(),a=n(a),a=g.Base64.of().encode(a);return CryptoJS.SHA1(a).toString()},getSignData:function(a){a=(a||this.signatureData).protectedData;for(var b={},c=0;c<a.length;c++)b[a[c].field]=a[c].value;return g.Base64.of().encode(n(b))},
showSignSignatureDialog:function(a){var b={target:g.is("Array",a.target)?a.target:[a.target],title:"\u6570\u5b57\u7b7e\u540d",onShow:function(){var a=this;setTimeout(function(){a.find("#kg-password").focus()},40)},onOk:function(){var b=this.find("#kg-password");if(!b.val())return v.alert("\u8bf7\u8f93\u5165\u5bc6\u7801\uff01",function(){b.focus()}),!1;a._onOk.call(this,b.val());return!1}};return this.showDialog("signSignatureBtl",b)},signSignature:function(a){var b=this;return b.showSignSignatureDialog({target:b,
_onOk:function(c){var f=this,e=b.getH5SignData();b.runSign(e,c,function(c){c.result?b.fireUpdate(function(a){a&&f.remove()}):b.warning(c);a&&a(c)})}})},showRevokeSignatureDialog:function(a){var b={target:g.is("Array",a.target)?a.target:[a.target],title:"\u64a4\u9500\u7b7e\u7ae0",onShow:function(){var a=this;setTimeout(function(){a.find("#kg-password").focus()},40)},onOk:function(){var b=this.find("#kg-password");if(!b.val())return v.alert("\u8bf7\u8f93\u5165\u5bc6\u7801\uff01",function(){b.focus()}),
!1;a._onOk.call(this,b.val());return!1}};return this.showDialog("revokeSignatureBtl",b)},revokeSignature:function(a){var b=this,c={target:b,_onOk:function(c){var f=this;v.showLoading();b.sealService.verifyPwd({pwd:c,keysn:b.signatureData.keysn,successCall:function(c){v.hideLoading();c.result?void 0!==e.options.delCallBack&&e.options.delCallBack?e.options.delCallBack(b.signatureid,b.signatureData)&&b.fireRemove(function(a){a&&(f.remove?f.remove():b.remove())}):b.fireRemove(function(a){a&&(f.remove?
f.remove():b.remove())}):b.warning(c);a&&a(c)},errorCall:function(a){b.error(a)}})}};if(e.options.showNoPW&&"server"==e.options.sealType)c._onOk(e.options.password);else return b.showRevokeSignatureDialog(c)},showDialog:function(a,b){var c=g.is("Array",b.target)?b.target:[b.target],f=g.extend({title:"\u7535\u5b50\u7b7e\u7ae0",onCancel:b.errCall||function(){v.hideLoading();return!0},content:function(){var b=[e.options.template[a]].concat(c);return g.template.apply(null,b)}},b),f=v.showDialog(a,f);
if("showSealsBtl"===a){var h=f.find("#sealTpl-dialog"),t=!1,u=0,l=0,m=0,k=0;h.prevObject[0].onmousedown=function(a){t=!0;a=a||event;u=a.clientX;l=a.clientY;m=parseInt(h.prevObject[0].style.top);k=parseInt(h.prevObject[0].style.left)};h.prevObject[0].onmousemove=function(a){if(t){a=a||event;var b=k+a.clientX-u;a=m+a.clientY-l;0<b&&0<a&&(h.prevObject[0].style.left=b+"px",h.prevObject[0].style.top=a+"px")}};h.prevObject[0].onmouseup=function(a){t&&(t=!1,k=m=l=u=0)}}return f},runMove:function(a,b,c){var f=
this;C.trigger("startMove",f,a,b);b=M.create(b,a,!0);b.onend=function(a,b,e,g){c&&c(b,e,g);C.trigger("endMove",f,a,e,g);b&&(a=l(this),f.updatePos(a.attr("elemid"),{marginLeft:e,marginTop:g}),f.fireUpdate())};a.preventDefault();return b},runSign:function(a,b,c){var f=this,h=f.signatureData;v.showLoading();f.certService.sign({keysn:this.signatureData.keysn,signsn:this.signatureData.seal.signsn,password:b,signMeta:a,successCall:function(b){v.hideLoading();b.result&&(b.signeddata?(b.certinfo.algName=
b.certinfo.algName.toUpperCase(),f.updateItem("signMeta",{hashAlg:a[0].hashAlg,encryptAlg:a[0].encryptAlg,signdata:a[0].signdata,signeddata:f.__findSignedData(b.signeddata),certinfo:b.certinfo})):(b.result=!1,b.errcode="signErr"),h.certType=e.options.certType);c&&c(b)},errorCall:function(a){f.error(a)}})}});var v=x();e.options=l.extend({b64Url:"/iWebSignature_base64",imageUrl:"/iWebSignature_image"},m.options,{dialogConfig:{okValue:"\u786e  \u5b9a",cancelValue:"\u53d6  \u6d88",fixed:!0,backdropOpacity:.2,
modal:!0},template:{}},window.KGCONFIG);e.addProvider=function(a,b,c){e.factory[a][b]=c};var I;e.init=function(a,b){this.Seals={};g.extend(e.options,a);var c=e.options;c.serverUrl&&(c.b64Url="/signature/b64",c.imageUrl="/signature/image",c.serverUrl+="/rest");"client"==c.sealType?(c.clientUrl=c.https,I=e.aisleKing=m.surry(c.clientUrl?c.clientUrl:"http://127.0.0.1:9581","IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319")):I=e.aisleKing=m.surry(c.serverUrl||c.clientUrl,"IWEBASSIST.iWebAssistCtrl.1",
"4240FB41-A213-42B6-8CB5E6705C99B319");var f=c.clientConfig;if(f&&"client"===c.sealType)for(var h in f)e.AXI("SetParamByName","SOFTTYPE",f[h],b);else b&&b();C.trigger("init")};e.factory={cert:{},seal:{}};e.SealService=J;e.CertService=K;e.asyn={};e._create=function(a){var b=this;b.setAttr(a);b.certService=new e.factory.cert[b.certType](a);b.sealService=new e.factory.seal[b.sealType](a);b.on("createSignature",function(a,f,e){a=[];var c=b._getLogInfo({LOGTYPE:"00",LOGSORT:"13",LOGMEMO:"\u76d6\u7ae0\u6210\u529f",
LOGSORTSUBCLASS:"1301"});a.push(g.extend(f||{},c));e&&a.push(b._getLogInfo({LOGTYPE:"00",LOGSORT:"304",LOGMEMO:"\u6570\u5b57\u7b7e\u540d\u6210\u529f"}));b.sealService.saveLog(a)});return this};x=function(){};x.prototype=e.prototype;x=new x;e._create.prototype=x;l.extend(x,{keyData:null,sealExpired:function(a,b,c,f,h){var g=this,m=!0;if(void 0===e.options.valid||null===e.options.valid||!1===e.options.valid)return g.certExpired(b,c,f);if(void 0!==a.endata&&null!==a.endata){var k=a.endata;h=parseInt(c.substr(0,
4));a=parseInt(c.substr(5,2));var m=parseInt(c.substr(8,2)),n=parseInt(k.substr(0,4)),P=parseInt(k.substr(5,2)),k=parseInt(k.substr(8,2));h>n?(g.warning({errcode:"11104"}),m=!1):h==n?a>P?(g.warning({errcode:"11104"}),m=!1):a==P?m>k?(g.warning({errcode:"11104"}),m=!1):m=!0:m=!0:m=!0}else return a=e.options.serverUrl+"/key/SealIsExpired",h=(parseInt(h)+1).toString(),l.ajax({url:a,data:{keysn:g.keyData.keysn,year:(new Date).getFullYear(),month:(new Date).getMonth(),date:(new Date).getDate(),index:h},
async:!1,success:function(a){if(a.error)return alert(a.error),!1;if(0==a.result)return g.certExpired(b,c,f);g.warning({errcode:"11104"});return!1},error:function(a){alert(a)}}),!1;return m?g.certExpired(b,c,f):m},certExpired:function(a,b,c){var f=this,h=!1;if(void 0===e.options.valid||null===e.options.valid||!1===e.options.valid)return!0;m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("KGGetCerInfo","").ret(function(a){var e=parseInt(b.substr(0,
4)),g=parseInt(b.substr(5,2)),m=parseInt(b.substr(8,2));if(a.result){a=a.certinfo.notAfter;var l=parseInt(a.substr(0,4)),D=parseInt(a.substr(4,1)),D=0==D?parseInt(a.substr(5,1)):parseInt(a.substr(4,2)),k=parseInt(a.substr(6,1)),k=0==k?parseInt(a.substr(7,1)):parseInt(a.substr(6,2));e>l?f.warning({errcode:"11103"}):e==l?g>D?f.warning({errcode:"11103"}):g==D?m>k?f.warning({errcode:"11103"}):h=!0:h=!0:h=!0}else alert("\u83b7\u53d6key\u8bc1\u4e66\u5931\u8d25\uff01");void 0!==c&&null!==c&&c(h)});return h},
runHW:function(a,b){var c=this;v.showLoading();"undefined"!=typeof a.imageData&&null!=a.imageData&&(void 0!==a.beginCall&&a.beginCall&&a.beginCall.call(c),c.sealService.loadSeal({data:a.imageData,successCall:function(f){v.hideLoading();if(f.result&&f.seals){for(var e in f.seals){f.seals=[{width:a.width,height:a.height,imgext:f.seals[e].imgext,signname:a.name,signsn:f.seals[e].signsn,username:f.seals[e].username,imgdata:a.imageData,headinfoex:f.seals[e].headinfoex}];break}c.keyData=f;c.showSeals(b)}else c.warning(f)},
errorCall:function(a){c.error(a)}}))},run:function(a){var b=this;b.keyData?b.showSeals(a):(v.showLoading(),void 0!==a.beginCall&&a.beginCall&&a.beginCall.call(b),b.sealService.loadSeal({successCall:function(c){v.hideLoading();c.result?c.seals?c.seals.length&&(b.keyData=c,void 0!==e.options.imgtag&&0!==e.options.imgtag&&void 0===c.ServerTime?void 0!==b.serverUrl&&null!==b.serverUrl?(c={usercode:b.usercode,keysn:b.keyData.keysn,signname:b.signname,authcode:e.authcode},m.surry(b.serverUrl).request("/key/load",
c).ret(function(c){c.result?(b.curDate=c.ServerTime,b.keyData=c,b.showSeals(a)):alert(c.errmsg)}).fail(function(c,e){b.curDate=(new Date).toLocaleString();b.showSeals(a)})):(b.curDate=(new Date).toLocaleString(),b.showSeals(a)):(b.curDate=c.ServerTime,b.showSeals(a))):b.warning({errcode:"11100"}):b.warning(c)},errorCall:function(a){b.error(a)}}));return this},getSealsByKeysn:function(a,b){var c=this;c.sealService.loadSeal({successCall:function(a){if(a.result){var e=[];if(void 0!==b&&null!=b){for(var f=
0;f<a.seals.length;++f)e[f]=c.toBase64Img(a.seals[f]);b(e)}}},errorCall:function(a){c.error(a)}})},loadSeals:function(a){var b=this;b.sealService.loadSeal({successCall:function(b){void 0!==a&&null!==a&&null!==b&&void 0!==b.seals&&null!==b.seals&&a(b)},errorCall:function(a){b.error(a)}})},runSS:function(a,b){var c=this;if(null!==b)if(c.keyData=b,null==b.seals||0==b.seals.length)v.alert("\u672a\u641c\u7d22\u5230\u60a8\u8981\u7684\u7b7e\u7ae0\uff01");else if(void 0!==e.options.imgtag&&0!==e.options.imgtag&&
void 0===b.ServerTime)if(void 0!==c.serverUrl&&null!==c.serverUrl){var f={usercode:c.usercode,keysn:c.keyData.keysn,signname:c.signname,authcode:e.authcode};m.surry(c.serverUrl).request("/key/load",f).ret(function(b){b.result?(c.curDate=b.ServerTime,c.keyData=b,c.showSeals(a)):alert(b.errmsg)}).fail(function(b,e){c.curDate=(new Date).toLocaleString();c.showSeals(a)})}else c.curDate=(new Date).toLocaleString(),c.showSeals(a);else c.curDate=b.ServerTime,c.showSeals(a)},formatPos:function(a,b,c){var e=
{};if(a){var h=function(a){var f=a.elemid||a[0].id;f||(f="body");e[f]=void 0!=b&&void 0!=c?{marginLeft:b,marginTop:c}:g.filter(a,f)};if(g.is("Array",a))for(var m=0;m<a.length;m++)h(a[m]);else g.is("String",a)?e[a]=void 0!=b&&void 0!=c?{marginLeft:b,marginTop:c}:{}:h(a)}else e.body={};return e},exec:function(a,b,c,f,h,m){var l=this;delete l.signatureData;var k={timestamp:{time:void 0==a.signtime?(new Date).getTime():(new Date(Date.parse(a.signtime.replace(/-/g,"/")))).getTime(),signtime:void 0==a.showtime?
a.signtime:a.showtime,timestampInfo:a.timestampInfo},appname:navigator.userAgent,documentid:void 0==a.documentid?l.documentid:a.documentid,documentname:void 0==a.documentname?l.documentname:a.documentname,moveable:g["boolean"](a,"moveable",e.options.moveable),keysn:l.keyData.keysn,orgname:l.keyData.orgname,usercode:l.keyData.usercode,username:l.keyData.username||c.username,seal:c,protectedData:l.getProtectedData(a.protectedItems),sealType:a.sealType||l.sealType,extparam:a.extparam,ver:e.version,dateTime:a.datetime};
l.signatureData=k;l.certService.sData=l.signatureData;l.sealService.sData=l.signatureData;v.showLoading();var t=a.autoCert||l.autoCert,n=function(a){var b=l.signatureData;if(a&&a.position){if(a.offsetX&&a.offsetY)a.changeOffsetXY&&a.changeOffsetXY(a),b.position=l.formatPos(a.position,a.offsetX,a.offsetY);else if(a.changeOffsetXY){var f={width:Math.ceil(9600*parseFloat(c.width)/254),height:Math.ceil(9600*parseFloat(c.height)/254)},f=a.changeOffsetXY(f);b.position=l.formatPos(a.position,f.offsetX,f.offsetY)}else b.position=
l.formatPos(a.position);f=a.signatureid||l.genId();a&&a.scopePosition&&(void 0==e.options.extra&&(e.options.extra={}),e.options.extra[f]={scopePosition:a.scopePosition});b.timeid=(new Date).getTime();var h=(new e(f,b)).load(e.options);a.okCall&&(b={name:c.signname,height:c.height,width:c.width,imgdata:l.toBase64Img(c)},a.isBatchSignature?a.okCall.call(h,function(a){a||h.remove()},a.documentid):a.okCall.call(h,function(b){b?(l.trigger("createSignature",h,a.logMeta,t),h.show()):h.remove()},b));v.hideLoading()}else throw Error("no set position");
};if(t){l.getSignData(k);k=l.getH5SignData();if(a.signMeta)k[g.is("Array",a.signMeta)?"concat":"push"](a.signMeta);a.beforeSignCall&&a.beforeSignCall.call(l,k);h?"client"==e.options.sealType?l.runSign(k,f,function(e){e.result&&(n(a),m&&1<m.batchSignature.length&&(a.documentid=m.batchSignature[m.batchSignature.length-1].documentid,a.documentname=m.batchSignature[m.batchSignature.length-1].documentname,--m.batchSignature.length,l.exec(a,b,c,f,h,m)));b(e)}):l.runSign(k,f,function(c){c.result&&n(a);b(c)}):
l.runSign(k,f,function(c){c.result&&n(a);b(c)})}else h?n(a):l.sealService.verifyPwd({pwd:f,keysn:k.keysn,successCall:function(c){c.result&&n(a);b(c)},errorCall:function(a){l.error(a)}})},runPwd:function(a){var b=this;b.showPwdDialog({_onOk:function(c){e.options.showNoPW=!0;e.options.password=c;var f=this.find("#kg-remenberPwd").is(":checked");b.trigger("execSuccess",this,c,f);b.run(l.extend(a,{beginCancalCall:function(){e.options.showNoPW=!1;e.options.password=""}}))}})},showPwdDialog:function(a){var b=
this,c=a._onOk;b.showDialog("passwordTpl",{onShow:function(){b.trigger("showSealsDialog_PW",this)},onOk:function(){var a=this.find("#kg-password"),b=a.val();b?(c.call(this,b),this.remove()):v.alert("\u8bf7\u8f93\u5165\u5bc6\u7801\uff01",function(){a.focus()});return!1},content:function(){return g.template.apply(null,[v.template.passwordTpl])}})},showSeals:function(a){var b=this,c={cancelCall:a.cancelCall,beginCancalCall:a.beginCancalCall,protectedItems:a.protectedItems,_onOk:function(c,f,g,l,m,k){var h=
this,t=new v.kgFont(null==h.fontSel?null==b.signdate?{}:b.signdate:h.fontSel);a.datetime={isCheck:h.isCheck,fontDate:t};void 0!=l&&null!=l?(a.signtime=l,void 0!=m&&null!=m?(a.showtime=(l+" ("+m.TimeExt+")").replace(/-/g,"/"),a.showtime+="(\u65f6\u95f4\u6233\u670d\u52a1\u5668)",a.timestampInfo=m):(a.showtime=(new Date(Date.parse(l.replace(/-/g,"/")))).toLocaleString(),a.showtime+="(\u670d\u52a1\u5668\u65f6\u95f4)")):(a.signtime=void 0,a.showtime=(new Date).toLocaleString(),a.showtime+="(\u672c\u5730\u65f6\u95f4)");
void 0===e.options.valid||null===e.options.valid||!1===e.options.valid?a.batchSignature?b.sealService.verifyPwd({pwd:f,usercode:void 0==a.usercode?"":a.usercode,keysn:b.keyData.keysn,successCall:function(g){if(g.result){for(g=0;g<a.batchSignature.length&&(a.batchSignature[g].signtime=a.signtime,a.batchSignature[g].showtime=a.showtime,a.batchSignature[g].position=a.position,a.batchSignature[g].autoCert=a.autoCert,a.batchSignature[g].okCall=a.okCall,a.batchSignature[g].cancelCall=a.cancelCall,a.batchSignature[g].beginCall=
a.beginCall,a.batchSignature[g].endCall=a.endCall,a.batchSignature[g].protectedItems=a.protectedItems,a.batchSignature[g].datetime=a.datetime,a.batchSignature[g].isBatchSignature=!0,b.exec(a.batchSignature[g],function(c){if(c.result)if(void 0!==e.options.showNoPW||!0===e.options.showNoPW)void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b),h.remove();else{if(void 0===e.options.showSealsDlg||!0===e.options.showSealsDlg)c=k&&1==k?k:h.find("#kg-remenberPwd").is(":checked"),b.trigger("execSuccess",
h,f,c),void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b),h.remove()}else b.warning(c)},c,f,!0,a),void 0!==a.batchSignature[g].endCall&&a.batchSignature[g].endCall&&a.batchSignature[g].endCall.call(b),"client"!=e.options.sealType||!a.autoCert);++g);void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b);b.remove()}else b.error(g.errcode)},errorCall:function(a){b.error(a)}}):(b.exec(a,function(c){if(c.result)if(void 0!==e.options.showNoPW||!0===e.options.showNoPW)void 0!==
a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b),h.remove();else{if(void 0===e.options.showSealsDlg||!0===e.options.showSealsDlg)c=void 0!=k?k:h.find("#kg-remenberPwd").is(":checked"),b.trigger("execSuccess",h,f,c),void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b),h.remove()}else b.warning(c)},c,f),void 0!==a.endCall&&a.endCall&&a.endCall.call(b)):void 0!==b.curDate&&null!==b.curDate&&b.sealExpired(c,a,b.curDate,function(g){g?a.batchSignature?b.sealService.verifyPwd({pwd:f,
keysn:b.keyData.keysn,successCall:function(g){if(g.result){for(g=0;g<a.batchSignature.length;++g)a.batchSignature[g].signtime=a.signtime,a.batchSignature[g].showtime=a.showtime,a.batchSignature[g].position=a.position,a.batchSignature[g].autoCert=a.autoCert,a.batchSignature[g].okCall=a.okCall,a.batchSignature[g].cancelCall=a.cancelCall,a.batchSignature[g].beginCall=a.beginCall,a.batchSignature[g].endCall=a.endCall,a.batchSignature[g].protectedItems=a.protectedItems,a.batchSignature[g].datetime=a.datetime,
a.batchSignature[g].isBatchSignature=!0,b.exec(a.batchSignature[g],function(c){if(c.result)if(void 0!==e.options.showNoPW||!0===e.options.showNoPW)void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b),h.remove();else{if(void 0===e.options.showSealsDlg||!0===e.options.showSealsDlg)c=k&&1==k?k:h.find("#kg-remenberPwd").is(":checked"),b.trigger("execSuccess",h,f,c),void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b),h.remove()}else b.warning(c)},c,f,!0),void 0!==
a.batchSignature[g].endCall&&a.batchSignature[g].endCall&&a.batchSignature[g].endCall.call(b);void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b);h.remove()}else b.error(g.errcode)},errorCall:function(a){b.error(a)}}):(b.exec(a,function(c){if(c.result){if(void 0===e.options.showSealsDlg||!0===e.options.showSealsDlg)c=k&&1==k?k:h.find("#kg-remenberPwd").is(":checked"),b.trigger("execSuccess",h,f,c),void 0!==a.beginCancalCall&&a.beginCancalCall&&a.beginCancalCall.call(b),h.remove()}else b.warning(c)},
c,f),void 0!==a.endCall&&a.endCall&&a.endCall.call(b)):b.warning({errcode:"11103"})},g)}};if(void 0!==e.options.showSealsDlg&&!1===e.options.showSealsDlg)if(void 0===e.options.password&&void 0!==b.password&&(e.options.password=b.password),void 0===e.options.password)v.alert("\u672a\u8bbe\u7f6e\u7b7e\u7ae0\u5bc6\u7801\uff01");else if(void 0!=e.options.timestamp&&1==e.options.timestamp)if("client"==e.options.sealType){var f=m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");
f.invoke("KGGetTSURLInfo").ret(function(h){h.result?f.invoke("KGGetTSWithDigest",h.TimeStampUrl,h.TimeStampUserName,h.TimeStampPassword,b.getSignTimeStamp(b.getProtectedData(a.protectedItems)),"").ret(function(a){a.result?c._onOk.call(d,b.keyData.seals[0],e.options.password,0,a.TimeStr,a):(a.errmsg?b.error(a.errmsg):b.error(a.errcode,"KGGetTSWithDigest"),c._onOk.call(d,keyData.seals[$seals.attr("index")],pwdVal,$seals.attr("index")))}):(b.error(h.errcode,"KGGetTSURLInfo"),c._onOk.call(d,keyData.seals[$seals.attr("index")],
pwdVal,$seals.attr("index")))})}else l.ajax({url:e.options.serverUrl+"/key/getTimeStamp",data:{keysn:b.keyData.keysn},async:!1,success:function(a){a.result?c._onOk.call(this,b.keyData.seals[0],e.options.password,0,a.timestamp):c._onOk.call(this,b.keyData.seals[0],e.options.password,0)},error:function(a){c._onOk.call(this,b.keyData.seals[0],e.options.password,0)}});else c._onOk.call(d,b.keyData.seals[0],e.options.password,0);else this.showSealsDialog(c)},showSealsDialog:function(a){var b=this,c=b.keyData;
null!=b.signdate&&(c.signDateIsCheck=b.signdate.ischeck);var f=[c],h=a._onOk,k=a.beginCancalCall,n={onCancel:a.cancelCall,onShow:function(){var a=this,c=a.find(".kg-switcher");if(c.length){var f=new g.Switcher(c[0],b.switcher||{});l(".arrow-right").click(function(a){a.preventDefault();f.swipeNext()});l(".arrow-left").click(function(a){a.preventDefault();f.swipePrev()});l(".kg-guide span").click(function(a){a.preventDefault();f.to(+this.getAttribute("index"))});b.switcher=f}a.find("#kg-dateSet").click(function(c){b.showFontDialog(a)});
b.trigger("showSealsDialog",a);e.options.showNoPW||b.trigger("showSealsDialog_PW",a)},onOk:function(){var f=this,g=f.find("#kg-password"),k=g.val()||e.options.password;if(!k)return v.alert("\u8bf7\u8f93\u5165\u5bc6\u7801\uff01",function(){setTimeout(function(){g.focus()},100)}),!1;var n=f.find(".kg-wrapper .active");f.isCheck=f.find("#kg-addDate").is(":checked");var t=f.find("#kg-remenberPwd").is(":checked");if("client"==e.options.sealType&&b.keyData.seals[n.attr("index")].SealTag&&"GM"==b.keyData.seals[n.attr("index")].SealTag){var u=
m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");u.invoke("KGValidate_GM","",b.keyData.seals[n.attr("index")].SealCert,b.keyData.seals[n.attr("index")].ValidStart,b.keyData.seals[n.attr("index")].ValidEnd,b.keyData.seals[n.attr("index")].CertList,"").ret(function(g){if(g.result)if(void 0!=e.options.timestamp&&1==e.options.timestamp)if("client"==e.options.sealType){var u=m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");
u.invoke("KGGetTSURLInfo").ret(function(e){e.result?u.invoke("KGGetTSWithDigest",e.TimeStampUrl,e.TimeStampUserName,e.TimeStampPassword,b.getSignTimeStamp(b.getProtectedData(a.protectedItems)),"").ret(function(a){a.result?h.call(f,c.seals[n.attr("index")],k,n.attr("index"),a.TimeStr,a,t?!0:!1):(a.errmsg?b.error(a.errmsg):b.error(a.errcode,"KGGetTSWithDigest"),h.call(f,c.seals[n.attr("index")],k,n.attr("index"),void 0,void 0,t?!0:!1))}):(b.error(e.errcode,"KGGetTSURLInfo"),h.call(f,c.seals[n.attr("index")],
k,n.attr("index"),void 0,void 0,t?!0:!1))})}else l.ajax({url:e.options.serverUrl+"/key/getTimeStamp",data:{keysn:b.keyData.keysn},async:!1,success:function(a){a.result?h.call(this,c.seals[n.attr("index")],k,n.attr("index"),a.timestamp,void 0,t?!0:!1):h.call(this,c.seals[n.attr("index")],k,n.attr("index"),void 0,void 0,t?!0:!1)},error:function(a){h.call(this,c.seals[n.attr("index")],k,n.attr("index"),void 0,void 0,t?!0:!1)}});else h.call(f,c.seals[n.attr("index")],k,n.attr("index"),void 0,void 0,t?
!0:!1);else return b.error(g.errcode,"KGValidate_GM"),!1})}else return n=f.find(".kg-wrapper .active"),f.isCheck=f.find("#kg-addDate").is(":checked"),void 0!=e.options.timestamp&&1==e.options.timestamp?"client"==e.options.sealType?(u=m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319"),u.invoke("KGGetTSURLInfo").ret(function(e){e.result?u.invoke("KGGetTSWithDigest",e.TimeStampUrl,e.TimeStampUserName,e.TimeStampPassword,b.getSignTimeStamp(b.getProtectedData(a.protectedItems)),
"").ret(function(a){a.result?h.call(f,c.seals[n.attr("index")],k,n.attr("index"),a.TimeStr,a):(a.errmsg?b.error(a.errmsg):b.error(a.errcode,"KGGetTSWithDigest"),h.call(f,c.seals[n.attr("index")],k,n.attr("index")))}):(b.error(e.errcode,"KGGetTSURLInfo"),h.call(f,c.seals[n.attr("index")],k,n.attr("index")))})):l.ajax({url:e.options.serverUrl+"/key/getTimeStamp",data:{keysn:b.keyData.keysn},async:!1,success:function(a){a.result?h.call(f,c.seals[n.attr("index")],k,n.attr("index"),a.timestamp):h.call(f,
c.seals[n.attr("index")],k,n.attr("index"))},error:function(a){h.call(f,c.seals[n.attr("index")],k,n.attr("index"))}}):h.call(f,c.seals[n.attr("index")],k,n.attr("index")),!1},content:function(){f.push(b.toBase64Img);var a=[e.options.template.showSealsBtl].concat(f);e.options.showNoPW&&(a=[e.options.template.showSealsBtl_nopassword].concat(f));return g.template.apply(null,a)}};void 0!==k&&k&&(n=g.extend({onCancel:function(){void 0!==k&&k&&k.call(b);this.close()}},n));e.options.showNoPW?b.showDialog("showSealsBtl_nopassword",
n):b.showDialog("showSealsBtl",n)},showFontDialog:function(a){var b=this,c=v.dafaultDate,f=null==b.signdate?{}:b.signdate,h=v.defaultFont,b=this,b=null==f.fontFormat?h.fontFormat:f.fontFormat,k=null==f.fontFamily?h.fontFamily:f.fontFamily,n=null==f.fontSize?h.fontSize:f.fontSize,w=h.fontColor;null!=f.fontColor&&/^#([0-9a-fA-f]{6})$/.test(f.fontColor)&&(w=f.fontColor.toUpperCase());f=null==f.position?h.position:f.position;null!=a.fontSel&&(b=a.fontSel.fontFormat,k=a.fontSel.fontFamily,n=a.fontSel.fontSize,
w=a.fontSel.fontColor,f=v.fontTemplate.position[a.fontSel.fontPositionIndex]);var q=this.getArrayPush(e.options.fontTemplate.fontFormat,b),r=[{fontFormat:this.getFormatDate(q,c),fontFamily:this.getArrayPush(e.options.fontTemplate.fontFamily,k),fontSize:this.getArrayPush(e.options.fontTemplate.fontSize,n),fontColor:this.getArrayPush(e.options.fontTemplate.fontColor,w),fontPosition:e.options.fontTemplate.position,dFontFormat:m.Utils.formatDate(new Date(c),b),dFontFamily:k,dFontSize:n,dFontColor:w,dFontPosition:f}],
p=v.showDialog("dateSetBtl",{title:"\u65e5\u671f\u8bbe\u7f6e",content:function(){var a=[e.options.template.dateSetBtl].concat(r);return g.template.apply(null,a)},onOk:function(){var b=this.find("#kg-fontFormat").get(0).selectedIndex;a.fontSel={fontFormat:q[b],fontFamily:this.find("#kg-fontFamily").val(),fontSize:this.find("#kg-fontSize").val(),fontColor:m.Utils.colorHex(this.find("#kg-select-color").css("backgroundColor")),fontPositionIndex:this.find("#kg-fontPosition").get(0).selectedIndex}}});p.find("#kg-select-color").on("click",
function(){p.find(".kg-color-div").css("display","block");p.find("#kg-color-ul").css("display","block")});p.find("#kg-color-ul li a").click(function(){l("#kg-select-color").css("backgroundColor",l(this).css("backgroundColor"));p.find(".kg-color-div").css("display","none");p.find("#kg-color-ul").css("display","none")});p.find(".kg-color-div").on("mouseover",function(a){this.contains(a.fromElement||a.relatedTarget)||l(this).show()});p.find(".kg-color-div").on("mouseout",function(a){this.contains(a.toElement||
a.relatedTarget)||l(this).hide()});return p},getArrayPush:function(a,b){-1==jQuery.inArray(b,a)&&a.push(b);return a},getFormatDate:function(a,b){for(var c=[],f=0;f<a.length;f++)c[f]=m.Utils.formatDate(new Date(b),a[f]);return c},genId:function(){var a=(new Date).getTime(),b=""+Math.ceil((9301*(new Date).getTime()+49297)%233280/233280*99999),c=5-b.length;if(0<c)for(var f=0;f<c;f++)b="0"+b;return a+b},getSeal:function(a){return this.keyData.seals[a]},saveSignature:function(a,b,c,f){var h=this;void 0!=
a&&void 0!=b&&void 0!=c&&(a=void 0!=e.options.cache_path&&null!=e.options.cache_path?{documentId:a,signatureId:b,signaturedata:c,cachepath:e.options.cache_path}:{documentId:a,signatureId:b,signaturedata:c,cachepath:""},m.surry(e.options.serverUrl).request("/signature/saveHtmlSignature",a).ret(function(a){void 0!==f&&null!==f&&f.call(h,a)}).fail(function(a,b){alert(b)}))},removeSignature:function(a,b,c){var f=this;void 0!=a&&void 0!=b&&(a={documentId:a,signatureId:b},m.surry(e.options.serverUrl).request("/signature/reomveHtmlSignature",
a).ret(function(a){void 0!==c&&null!==c&&c.call(f,a)}).fail(function(a,b){alert(b)}))},getSaveSignatures:function(a,b){void 0!=a&&m.surry(e.options.serverUrl).request("/signature/getHtmlSignature",{documentId:a}).ret(function(a){a.result&&b(a.sign)}).fail(function(a,b){alert(b)})}});l.extend(e.options,{certType:"client",sealType:"client",clientUrl:"http://127.0.0.1:9581",moveable:!0,signable:!0,fontTemplate:v.fontTemplate,template:{showSealsBtl:v.template.sealTpl,showSealsBtl_nopassword:v.template.sealTpl_nopassword,
signSignatureBtl:'<div id="kg-dialog-sign" class="kg-dialog kg-dialog-password kg-dialog-sign"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-3 kg-label">\u5bc6\u7801\uff1a</label><div class="kg-sm kg-sm-7"> <input type="password" name="kgpassword" autocomplete="new-password" id="kg-password" class="form-control"></div> </div></div></div>',revokeSignatureBtl:'<div id="kg-verifyPass" class="kg-dialog  kg-dialog-password"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-3 kg-label">\u7b7e\u7ae0\uff1a</label><div class="kg-sm kg-sm-7"><p class="kg-form-static"><%this.signatureData.seal.signname%></p></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-3 kg-label">\u5bc6\u7801\uff1a</label><div class="kg-sm kg-sm-7"> <input type="password" name="kgpassword" autocomplete="new-password" id="kg-password" class="form-control"></div> </div></div></div>',
dateSetBtl:'<div id="kg-setDate" class="kg-dialog kg-dialog-Date"><div class="kg-form"><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u683c\u5f0f\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontFormat" id="kg-fontFormat" class="kg-select kg-fontFormat"><% var fontFormat = this.fontFormat; %><% for(var i=0;i<fontFormat.length;i++) {%><% if(fontFormat[i] == this.dFontFormat){%><option class="kg-option" value="<% fontFormat[i]%>" selected><% fontFormat[i]%></option><%}else{%><option class="kg-option" value="<% fontFormat[i]%>"><% fontFormat[i]%></option><%}%><%}%></select></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u5b57\u4f53\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontFamily" id="kg-fontFamily" class="kg-select kg-fontFamily"><% var fontFamily = this.fontFamily; %><% for(var i=0;i<fontFamily.length;i++) {%><% if(fontFamily[i] == this.dFontFamily){%><option class="kg-option" value="<% fontFamily[i]%>" selected><% fontFamily[i]%></option><%}else{%><option class="kg-option" value="<% fontFamily[i]%>"><% fontFamily[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u5c3a\u5bf8\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontSize" id="kg-fontSize" class="kg-select kg-fontSize"><% var fontSize = this.fontSize; %><% for(var i=0;i<fontSize.length;i++) {%><% if(fontSize[i] == this.dFontSize){%><option class="kg-option" value="<% fontSize[i]%>" selected><% fontSize[i]%></option><%}else{%><option class="kg-option" value="<% fontSize[i]%>"><% fontSize[i]%></option><%}%><%}%></select></div> </div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u989c\u8272\uff1a</label><div class="kg-sm kg-sm-6"><% var fontColor = this.fontColor; %><div id="kg-select-color" class="kg-select-color" style="background-color:<% this.dFontColor%>"/><div class="kg-color-div"><ul class="kg-color-ul" id="kg-color-ul"><% for(var i=0;i<fontColor.length;i++){ %><li class="kg-color-li"><a href="javascript:;" style="background-color:<% fontColor[i]%>"></a></li><%}%></ul></div></div></div><div class="form-item clearfix"><label class="kg-sm kg-sm-4 kg-label">\u4f4d\u7f6e\uff1a</label><div class="kg-sm kg-sm-6"><select name="fontPosition" id="kg-fontPosition" class="kg-select kg-fontPosition"><% var fontPosition = this.fontPosition; %><% for(var i=0;i<fontPosition.length;i++) {%><% if(fontPosition[i] == this.dFontPosition){%><option class="kg-option" value="<% fontPosition[i]%>" selected><% fontPosition[i]%></option><%}else{%><option class="kg-option" value="<% fontPosition[i]%>"><% fontPosition[i]%></option><%}%><%}%></select></div> </div></div></div>'}});
e.list={};e.updateList=[];e.removeList=[];e.loadSignature=function(a,b,c){var f={};void 0==e.options.extra&&(e.options.extra={});f[a]=b;void 0!==s.extra&&null!==s.extra&&(e.options.extra[s.signatureid]=s.extra);p(f,c||function(a){a.verify()})};e.loadSignatures=function(a,b){var c={};void 0==e.options.extra&&(e.options.extra={});if(g.is("Array",a))for(var f=0;f<a.length;f++){var h=a[f];c[h.signatureid]=h.signatureData;void 0!==h.extra&&null!==h.extra&&(e.options.extra[h.signatureid]=h.extra)}else for(f in a)c[f]=
a[f];p(c,b||function(){e.verify()})};e.resetSignaturePos=function(a){void 0==e.options.extra&&(e.options.extra={});if(g.is("Array",a))for(var b=0;b<a.length;b++){var c=a[b];void 0!==c.extra&&null!==c.extra&&(e.options.extra[c.signatureid]=c.extra)}else for(b in a)e.options.extra[b]=a[b]};e.clearRPW=function(){delCookie("ksn");delCookie("pwd");delCookie("ck")};var C=new k("Signature");e.addLiseter=function(a,b){C.on(a,b)};e.verify=function(){var a=e.list,b=[];C.trigger("beforeVerify",f);for(var c in a){var f=
a[c];f._verify(null,{batchVerify:!0})||b.push(f);C.trigger("eachVerify",f)}C.trigger("verify",f);return b};e.bind=function(a){g.extend(e.asyn,a)};e.show=function(){var a=e.list,b;for(b in a)a[b].show()};e.hide=function(){var a=e.list,b;for(b in a)a[b].hide()};e.AXI=function(a,b,c,f){e.authcode=c;var g=m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");""!==b&&""!==c?g.invoke(a,b,c).ret(function(a){void 0!==f&&null!==f&&f(a)}):null!==b&&""!==b?g.invoke(a,
b).ret(function(a){void 0!==f&&null!==f&&f(a)}):g.invoke(a).ret(function(a){void 0!==f&&null!==f&&f(a)});return g};e.showAndHideBySignatureId=function(a,b){var c=e.list,f;for(f in c)0<=f.indexOf(a)&&(b?c[f].show():c[f].hide())};e.addIcon=function(a){var b=e.options.icons||[];b.push(a);e.options.icons=b};e.create=function(a){var b=l.extend({},e.options,a);void 0!==a&&void 0!==a.imgtag&&(e.options.imgtag=a.imgtag);return new e._create(b)};l.extend(e.prototype,{saveSignatures:function(){},getSignatures:function(){}});
k=function(a){var b=this;l.each(a,function(a,f){if("function"===typeof b[a])b[a](f);else b[a]=f})};g.inherit(k,e.SealService);x=function(a){var b=this;l.each(a,function(a,f){if("function"===typeof b[a])b[a](f);else b[a]=f})};g.inherit(x,e.CertService);l.extend(k.prototype,{saveLog:function(a){var b=[];g.is("Object",a)?b.push(a):b=a;a=n({MSG:b});m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("SetParamByName","SAVEMSG",a)},loadSeal:function(a){var b=
this,c=a.successCall,f=a.errorCall;a=m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319");b.appcode?a.invoke("SetParamByName","APPCODE",b.appcode):b.appcode="";a.invoke("KGGetKeyInfo").ret(function(a){if(a.result&&void 0!==e.options.imgtag&&null!==e.options.imgtag&&0!==e.options.imgtag){var g=[],h;for(h in a.seals){var k=a.seals[h];void 0!==k&&parseInt(k.imgtag)==e.options.imgtag&&(g[g.length]=a.seals[h])}a.seals=g}a.result?c.call(b,a):f.call(b,a)})},verifyPwd:function(a){var b=
this,c=a.successCall;m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("KGVerifyPin",a.pwd,a.keysn).ret(function(a){c.call(b,a)})}});l.extend(x.prototype,{verifySign:function(a){var b=this,c=a.successCall;m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("KGVerifySignMessage","123456",a.signdata,a.signeddata).ret(function(a){c.call(b,a.result||"-8"!==a.errcode?a:{result:!1})})},parseDate:function(a){var b=
new Date;b.setFullYear(a.substring(0,4),+a.substring(4,6)-1,a.substring(6,8));b.setHours(a.substring(8,10),a.substring(10,12),a.substring(12,14),0);return b.getTime()},sign:function(a){for(var b=this,c=a.successCall,f=a.errorCall,g=a.signMeta,k=[],n=[],p=0;p<g.length;p++){var q=g[p];k.push(q.signdata);n.push(""+q.signdata.length)}m.surry(e.options.clientUrl,"IWEBASSIST.iWebAssistCtrl.1","4240FB41-A213-42B6-8CB5E6705C99B319").invoke("KGCrySignMessage",a.password,k.join(";"),+n[0]).ret(function(a){a=
l.extend({},a);a.result&&(a.certinfo.notAfter=b.parseDate(a.certinfo.notAfter),a.certinfo.notBefore=b.parseDate(a.certinfo.notBefore));c.call(b,a)}).fail(function(a,c){f.call(b,c);a(null)})}});e.addProvider("cert","client",x);e.addProvider("seal","client",k);k=function(a,b){var c=this;c.sData=b;l.each(a,function(a,b){if("function"===typeof c[a])c[a](b);else c[a]=b})};g.inherit(k,e.SealService);var L=function(a,b){var c=this;c.sData=b;l.each(a,function(a,b){if("function"===typeof c[a])c[a](b);else c[a]=
b})};g.inherit(L,e.CertService);l.extend(k.prototype,{getSealsUrl:"/key/load",verifyPwdUrl:"/key/verify",saveLogUrl:"/signature/saveLog",saveLog:function(a){a=n(a);m.surry(this.serverUrl).request(this.saveLogUrl,{loginfo:a}).ret(function(a){a.result||e.prototype.warning.call(null,a)}).fail(function(a,c){e.prototype.warning.call(null,c)})},getPwdSaveTime:function(a,b){m.surry(e.options.serverUrl).request("/signature/getPwdSaveTime").ret(function(c){a(c.result?c.pwdTime:b)})},loadSeal:function(a){var b=
this,c=a.successCall,f=a.errorCall;a={usercode:b.usercode,keysn:b.keysn,signname:b.signname,authcode:b.authcode,password:e.options.password};m.surry(b.serverUrl).request(b.getSealsUrl,a).ret(function(a){if(a.result&&void 0!==e.options.imgtag&&null!==e.options.imgtag&&0!==e.options.imgtag){var g=[],h;for(h in a.seals){var k=a.seals[h];void 0!==k&&parseInt(k.imgtag)==e.options.imgtag&&(g[g.length]=a.seals[h])}a.seals=g}a.result?c.call(b,a):f.call(b,a)}).fail(function(a,c){f.call(b,c)})},verifyPwd:function(a){var b=
this,c=a.successCall,f=a.errorCall;a={usercode:void 0==b.sData?a.usercode:b.sData.usercode,keysn:void 0==b.sData?a.keysn:b.sData.keysn,password:a.pwd};m.surry(b.serverUrl).request(b.verifyPwdUrl,a).ret(function(a){c.call(b,a)}).fail(function(a,c){f.call(b,c)})}});l.extend(L.prototype,{signUrl:"/sign",verifySignUrl:"/sign/verify",verifySign:function(a){var b=this,c=b.sData,f=a.successCall,e=a.errorCall;m.surry(b.serverUrl).request(b.verifySignUrl,{certType:c.certType,isUTF8:c.isUTF8,signsn:c.seal.signsn,
html2sign:c.signMeta.html2sign,keysn:c.keysn,signsn:c.seal.signsn,signdata:a.signdata,signeddata:c.signMeta.signeddata,crtdata:c.signMeta.certinfo.crtdata}).ret(function(a){f.call(b,a)}).fail(function(a,c){e.call(b,c)})},sign:function(a){for(var b=this,c=a.signMeta,e=a.errorCall,g=a.successCall,k=[],l=0;l<c.length;l++){var n=c[l];k.push("$"+(n.hashAlg||b.hashAlg)+"|"+(n.encryptAlg||b.encryptAlg)+"$"+n.signdata)}a={keysn:a.keysn,password:a.password,signdata:k.join(";"),signsn:a.signsn};m.surry(b.serverUrl).request(b.signUrl,
a).ret(function(a){a.result&&(a.certinfo.algName=a.certinfo.algName.replace("with",""));g.call(b,a)}).fail(function(a,c){e.call(b,c)})}});e.addProvider("cert","server",L);e.addProvider("seal","server",k);e.alert=v.alert;var S=e.version={name:"1.0.20",code:100};return q.Signature=e});
// V1.0.0.322    
//# sourceMappingURL=c:/signature.min.map
